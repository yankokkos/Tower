version: '3.8'

services:
  # Aplicação completa (Frontend + Backend)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tower-rpg-app
    ports:
      - "80:80"
    environment:
      # Variáveis de ambiente do backend
      - DB_HOST=${DB_HOST:-mysql}
      - DB_NAME=${DB_NAME:-tower_rpg}
      - DB_USER=${DB_USER:-tower_user}
      - DB_PASS=${DB_PASS:-tower_pass}
      - DB_PORT=${DB_PORT:-3306}
      - JWT_SECRET=${JWT_SECRET:-TowerRPG_2024_Secure_Key_Change_In_Production}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400}
      - API_ENV=${API_ENV:-production}
      - API_DEBUG=${API_DEBUG:-false}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-*}
    volumes:
      # Montar config.env se existir
      - ./config.env:/var/www/html/config.env:ro
      # Persistir uploads se necessário
      - ./uploads:/var/www/html/uploads
    depends_on:
      - mysql
    restart: unless-stopped
    networks:
      - tower-network

  # Banco de dados MySQL (opcional - pode usar banco externo)
  mysql:
    image: mysql:8.0
    container_name: tower-rpg-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-tower_rpg}
      - MYSQL_USER=${MYSQL_USER:-tower_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-tower_pass}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./backend/database:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    networks:
      - tower-network
    # Comentar se usar banco externo
    # profiles:
    #   - with-db

volumes:
  mysql_data:

networks:
  tower-network:
    driver: bridge

